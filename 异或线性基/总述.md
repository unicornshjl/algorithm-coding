## 异或线性基 (XOR Basis)

### 1. 核心定义

**线性基**是一个关于**非负整数**异或运算的精妙数据结构.

- **目标:** 给定一个数字集合 $S$, 我们希望找到一个**元素个数尽可能少**的新集合 $B$ (称为 $S$ 的线性基).
- 要求: 1.  $S$ 中的元素通过任意组合异或所能得到的所有非 $0$ 异或和, 都能由 $B$ 中的元素通过任意组合异或不多不少地全部得到.
  2. 我们只关心异或和的值是否存在, 而不关心这个值能被构造出多少次 (即去重)
- **空间:** 本质上, 这是在 $\mathbb{F}_2$ (即模 $2$ 域) 上的向量空间. 集合 $S$ 中的每个数都可以看作一个高维的 $0$ $/$ $1$ 向量, 线性基 $B$ 就是这个向量空间的一组基.

### 2. 构建基础: 核心性质

以下三条关键性质, 它们是构建和操作线性基的理论基础:

- **(等价替换)** 对于集合中的任意两个数 $a$ 和 $b$, 用 $a \oplus b$ (异或和) 替换 $a$ 或 $b$ 中的任意一个 (例如, 集合变为 $\{a \oplus b, b, \dots\}$), **不会**影响原集合能异或出的非 0 值的集合. 这是高斯消元法的理论基础.
- **(冗余消除)** 如果 $a \oplus b = 0$ (即 $a = b$), 那么 $a$ 和 $b$ 互为冗余. 舍弃其中一个, **不会**影响原集合能异或出的非 0 值的集合.
- **(线性相关性)** 一个数字 $x$ 如果可以被集合中其他数字的异或和表示, 那么 $x$ 就是"线性相关"的. 如果我们在构造线性基的过程中发现一个 $x$ 最终变为 0 , 这证明原集合中存在**线性相关**, 意味着原集合中的**某个非空子集**可以异或出 $0$ .

### 3. 构造方法 (一): 普通消元法 (标准插入法)

这种方法逐个插入元素, 最终得到一组普通基.

- **目标:** 维护一个基底数组 $basis[]$, 其中 $basis[i]$ 存储的是一个**最高位为 1 且在第 $i$ 位**的数.
- **流程:**
  1. 初始化 $basis[M]$ 数组全为 $0$  (其中 $M$ 是最大位数, 例如 $60$).
  2. 遍历原数组中的每一个数 $x = a[i]$.
  3. 从高位向低位 (例如 `bit` 从 $M$ 遍历到 0) 检查 $x$:
     - 如果 $x$ 的第 `bit` 位为 $0$, 跳过.
     - 如果 $x$ 的第 `bit` 位为 1:
       - 如果 $basis[\text{bit}]$ **不存在 (为 0)**: 插入成功. 令 $basis[\text{bit}] = x$, 然后**跳出**对 $x$ 的处理并返回 `true` , 处理下一个 $a[i+1]$.
       - 如果 $basis[\text{bit}]$ **已存在**: 利用**性质 $1$**. 令 $x = x \oplus basis[\text{bit}]$. 此时 $x$ 的第 `bit` 位变为 $0$, 我们继续用这个新的 $x$ 去尝试更低的 `bit` 位.
- **处理 "0" (线性相关):**
  - 如果在上述过程中, $x$ 在所有位上都被消去, 最终变为 0 (即循环正常结束, $x$ 未能插入任何 $basis[\text{bit}]$), 这证明 $x$ 可以被已插入的基底表示.
  - 此时, 标记 `zero = true`. 这表明原数组 $a[]$ 中存在一个**非空子集**, 其异或和为 $0$.
- **基的大小 (秩):** 线性基的大小 ($\text Rank$) 就是 $basis[]$ 数组中非 0 元素的个数, 记为 `size`.
- **异或和个数:** 原数组 $a[]$ 能异或出的**不同**值的个数为 $2^{\text{size}}$.
  - 如果 `zero = true`, 这 $2^{\text{size}}$ 个值中包含 $0$.
  - 如果 `zero = false`, 这 $2^{\text{size}}$ 个值中不包含 $0$ (但空集的异或和 $0$ 仍然可以被基底构造, 只是原数组无法构造).

### 4. 构造方法 (二): 高斯消元法 (标准线性基)

这种方法构造出的基底为标准基 , 具有更优良的性质, 特别是用于查询第 $k$ 小异或和.

- **标准基定义:** 一个标准基 $basis[]$ 不仅满足 $basis[i]$ 的最高位是 $i$, 还额外满足: **对于任意 $basis[i]$, 它的所有非最高位 (即第 $j$ 位, $j < i$) 在其他所有基底 $basis[j]$ 的对应位置上都为 0**. (换句话说 $basis[i]$ 的第 $i$ 位是 1, 且 $basis[j]$ ( $j \neq i$) 的第 $i$ 位一定是 0).
- **初始化**: 维护一个变量 `len = 1`. 这个 `len` 记录了当前已经构造出的基底元素的数量. (我们将把 $a[1 \dots len-1]$ 作为基底存储的位置).
- **按位枚举:** **从高位 $i$ 向低位 $i$ (例如 $M \to 0$)** 进行主循环.
- **寻找主元 :** 对于当前的第 $i$ 位:
  - 从 $a[len]$ 开始, 向后遍历原数组 (即 `j` 从 `len` 到 `n`), 寻找**第一个**在第 $i$ 位上为 1 的数 $a[j]$.
- **交换与固定主元:**
  - 如果**找不到** (即 $a[len \dots n-1]$ 在第 $i$ 位上都为 0), 说明这一位没有基底, 直接跳过, 继续处理下一位 $(i-1)$ **而 $len$ 保持不变**.
  - 如果**找到了** (假设在 $j$ 位置):
    - 将 $a[j]$ 与 $a[len]$ **交换位置 (swap)**.
    - 现在, $a[len]$ 就是我们用于处理第 $i$ 位的 "主元" , 它的最高有效位是第 $i$ 位.
- **高斯消元 :**
  - "把除了 `len` 之外的且当前位上是 1 的元素异或上当前的基".
  - 遍历数组中**所有**其他元素 $a[k]$ (即 `k` 从 $1$ 到 $n$, 且 $k \neq len$).
  - 如果 $a[k]$ 的第 $i$ 位也为 1 (即 `(a[k] >> i) & 1 == 1`), 则执行:
    - $a[k] = a[k] \oplus a[len]$
  - 这一步操作确保了, **在所有 $a[k]$ ( $k \neq len$) 中, 第 $i$ 位都变为了 0.**
- **基底增长:** 完成第 $i$ 位的消元后, 意味着我们成功找到了一个以 $i$ 为最高位的基底 $a[len]$.
  - `len` 自增 1.
- **循环:** 继续处理下一位 $i-1$.

**最终结果:**

- 循环结束后, 我们让`len--` 这样一来 $a[1], a[1], \dots, a[len]$ 这 `len` 个数就组成了一个**标准线性基**. 
- $a[len + 1]$ 到 $a[n]$ 的所有元素都会变为 $0$ (它们是 "线性相关" 的).
- 如果在过程中, 某个 $a[j]$ 在交换前已经是 $0$ (或者在消元后变成了 $0$), 并且这个 $0$ 是由原数组中的非空子集异或得到的, 这就等价于我们之前讨论的 `zero = true` 的情况.

### 5. 线性基的应用

#### A. 查询最大异或和

- **方法:** 贪心.
- **流程:**
  1. 初始化 $ans = 0$.
  2. 从最高位 $M$ 向低位 0 遍历 $basis[]$ 数组
  3. 检查: 如果 $ans$ 异或上 $basis[i]$ 能使 $ans$ 变得更大, 那么就更新 $ans$.
  4. 即: $ans = \max(ans, ans \oplus basis[i])$.
- **原理:** 我们总是**贪心**地尝试让 $ans$ 的最高位变为 1.

#### B. 查询第 $k$ 小异或和 (需要标准线性基)

这是标准线性基 (高斯消元法) 的核心应用.

- **流程:**
  1. **重构基底:** 将 $basis[]$ 数组中的所有非 0 元素提取出来, 放入一个新数组 `b[]`. 设 `b[]` 的大小 (即线性基的 `size`) 为 `sz`.
  2. **处理 $k$:**
     - 注意: 线性基能异或出的最小的值**一定是 0** (通过"空集"异或得到).
     - 如果 `zero = true` (原数组能异或出 0), 那么第 $k$ 小的值就是 `b[]` 中元素构造出的第 $k-1$ 小的值 (因为 $0$ 是第 $1$ 小). 所以我们令 $k = k - 1$.
     - 如果 $k = 0$, 结果就是 $0$.
  3. **检查 $k$ 的范围:** 即 $k>2^{\text{sz}}$, 说明超出了能表示的范围, 返回 $-1$
  4. **构造 $ans$:**
     - 将 $k$ 视为一个二进制数.
     - $ans = 0$.
     - 遍历 $k$ 的每一位, 从 $i = 0$ 到 $\text{sz}-1$:
     - 如果 $k$ 的第 $i$ 位为 1 (即 `(k >> i) & 1 == 1`), 那么:
     - $ans = ans \oplus b[i]$.(要注意的是第 $i$ 位表示的是从右往左数 也就是从低位开始的第 $i$ 位)
  5. 返回 $ans$.
- **原理:** 标准线性基 `b[]` 中的 $2^{\text{sz}}$ 个组合值是**线性无关**的, 并且 `b[0]`, `b[1]`... 构成了异或空间的"坐标轴". $k$ 的二进制表示就是在这个空间中的坐标.

